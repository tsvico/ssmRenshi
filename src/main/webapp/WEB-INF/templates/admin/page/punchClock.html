<!DOCTYPE html>
<html lang="cn" xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/_fragments::head">
</head>
<body>
<div class="layui-main">
    <table lay-even class="layui-table layui-hide" lay-filter="mytable" lay-data="{id: 'idmytable'}">
        <thead>
        <tr>
            <th lay-data="{field:'id', width:50}">ID</th>
            <th lay-data="{field:'nickname', width:120}">用户名</th>
            <th lay-data="{field:'attendanceTime', width:140,sort: true}">时间</th>
            <th lay-data="{field:'userip', width:140}">IP</th>
            <th lay-data="{field:'remark', width:140}">备注</th>
            <th lay-data="{field:'describtion', width:140}">状态</th>
            <th th:if="${session.user.role_id==1}" lay-data="{field:'edits',minWidth: 280,toolbar: '#barDemo'}">操作</th>
        </tr>
        </thead>
        <!--/*@thymesVar id="punchclock" type="com.tsvico.pojo.PunchClock"*/-->
        <tbody th:each="punchclock : ${punchClocks}">
        <tr>
            <td th:text="${punchclock.id}"></td>
            <td th:text="${punchclock.nickname}"></td>
            <td th:text="${#dates.format(punchclock.attendanceTime,'yyyy-MM-dd HH:mm:ss')}"></td>
            <td th:text="${punchclock.userip}"></td>
            <td th:text="${punchclock.remark}"></td>
            <td th:text="${punchclock.punch_inTime}"></td>
            <td th:if="${session.user.role_id==1}"></td>
        </tr>
        </tbody>
    </table>
    <script type="text/html" id="toolbarDemo">
        <div class="layui-btn-container">
            <button type="button" class="layui-btn layui-btn-sm" lay-event="addNewDate">
                <i class="layui-icon">&#xe63c;</i> 打卡
            </button>
        </div>
    </script>
    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">
            <i class="layui-icon layui-icon-edit"></i>批注
        </a>&nbsp;&nbsp;
    </script>
</div>
<!--打卡-->
<div class="layui-row" id="daka" style="display:none;position: absolute;
    top: 0; left: 0; bottom: 0; right: 0;">
    <div class="layui-form-item">
        <div>
            <form class="layui-form">
                <div align="center">
                    当前位置：<p id="city"></p>
                </div><br>
                <div class="layui-form-item" }>
                    <label class="layui-form-label">打卡时间:</label>
                    <div class="layui-input-block" style="width: 250px">
                        <input type="text" id="in_text" name='' required  value=""
                               autocomplete="off" class="layui-input" readonly>
                    </div>
                    <div class="layui-form-item" style="margin-top: 0.4em;">
                        <div class="layui-input-block" style="width: 400px">
                            <button class="layui-btn layui-btn-normal" type="button" id="in_btn">打卡</button>
                        </div>
                    </div>
                </div>
                <br>
                <div class="layui-form-item" }>
                    <label class="layui-form-label">签退时间:</label>
                    <div class="layui-input-block" style="width: 250px">
                        <input type="text" id="out_text" name='' required value=""
                               autocomplete="off" class="layui-input" readonly>
                    </div>
                    <div class="layui-form-item" style="margin-top: 0.4em;">
                        <div class="layui-input-block" style="width: 400px">
                            <button class="layui-btn layui-btn-normal" type="button" id="out_btn">签退</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!--迟到-->
<div id="chidao" class="layui-form-item" style="display:none;position: absolute;
    top: 0; left: 0; bottom: 0; right: 0;">
    <div class="layui-input-block">
        <form class="layui-form">
            <div class="layui-form-item" }>
                <br><br><br>
                <label class="layui-form-label">迟到原因:</label>
                <div class="layui-input-block" style="width: 250px">
                    <input type="textbox" id="lateresult" name='' required
                           autocomplete="off" class="layui-input" >
                </div><br>
                <div class="layui-form-item">
                    <div class="layui-input-block" style="width: 400px">
                        <button class="layui-btn" type="button" id="latego">确定</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div th:replace="admin/_fragments::script"></div>
<script src="/js/common.js"></script>
<script>
    var root = "/admin/page/punchClock/";
    layui.use(['table','laydate'], function () {
        var table = layui.table;

        //转换静态表格
        var tabIns = table.init('mytable', {
            limit: 10 //注意：请务必确保 limit 参数（默认：10）是与你服务端限定的数据条数一致
            , page: true
            , toolbar: '#toolbarDemo' //开启头部工具栏，并为其绑定左侧模板
            , id: 'tableId'
            //支持所有基础参数
        });


        //头工具栏事件
        table.on('toolbar(mytable)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id);
            switch (obj.event) {
                case 'addNewDate':
                    //打卡
                    layer.open({
                        title: '打卡',
                        area: ['650px', '350px'],
                        type: 1,
                        content: $('#daka'),//跳转controller
                        cancel: function () {
                        },
                        success: function (layero,index) {
                            //获取打卡时间
                            $.ajax({
                                url: root+'in_time',
                                type: 'POST',
                                dataType: 'json',
                                data: {
                                },
                                success: function (in_time) {
                                    out_time();
                                    if (in_time.code===200){
                                        document.getElementById('in_text').value = in_time.data;
                                    }
                                },
                                error: function (XMLHttpRequest) {
                                    console.log('XMLHttpRequest:');
                                    console.log(XMLHttpRequest);
                                    alert('网络异常！尝试刷新网页解决问题');
                                }
                            });
                            function out_time(){
                                $.ajax({
                                    url: root+'out_time',
                                    type: 'POST',
                                    dataType: 'json',
                                    data: {
                                    },
                                    success: function (out_time) {
                                        if (out_time.code===200){
                                            document.getElementById('out_text').value = out_time.data;
                                        }
                                    },
                                    error: function (XMLHttpRequest) {
                                        console.log('XMLHttpRequest:');
                                        console.log(XMLHttpRequest);
                                        alert('网络异常！尝试刷新网页解决问题');
                                    }
                                })
                            }
                            $(function(){
                                //获取城市ajax
                                $.ajax({
                                    url: 'http://api.map.baidu.com/location/ip?ak=ia6HfFL660Bvh43exmH9LrI6',
                                    type: 'POST',
                                    dataType: 'jsonp',
                                    success:function(data) {
                                        $('#city').html(JSON.stringify(data.content.address_detail.province + "," + data.content.address_detail.city))
                                    }
                                });
                            })

                        }
                    });
                    break;
            }
        });
        //监听工具条
        table.on('tool(mytable)', function (obj) {
            var data = obj.data;
            console.log(data);
            delete data.edits; //删除object多余项
            if (obj.event === 'edit') {
                if (obj.event === 'del') {
                    layer.confirm('真的删除行么', function (index) {
                        obj.del();
                        layer.close(index);
                    });
                } else if (obj.event === 'edit') {
                    console.debug(data);
                }
            }
        });


    });

    $('#in_btn').on('click',function () {
        var loginaddress = $("#city").text();
        $.ajax({
            url: root+'punch_in',
            type: 'POST',
            dataType: 'json',
            data: {
                loginaddress: loginaddress,
            },
            success: function (res) {
                var result = res.intdata;
                //1:打卡成功，2：打卡失败（超过9点20，打卡状态为迟到），3：打卡失败（超过9点20后任不打卡，超过10点为缺席）
                if (result >= 1) {
                    layer.msg("打卡成功!");
                } else if (result === -2) {
                    layer.confirm("打卡成功，您已迟到，请填写迟到原因!",{
                        btn:['确定','取消']
                    },function (){
                        layer.open({
                            title: '迟到原因说明',
                            area: ['650px', '250px'],
                            type: 1,
                            content: $('#chidao'),
                            cancel: function () {
                            }
                        });
                    },function () {
                    })
                } else if (result == -3) {
                    layer.msg("打卡失败，当前状态为缺勤!");
                }else if(result == -4){
                    layer.msg("您已打卡，请勿重复打卡!");
                }
            },
            error: function (XMLHttpRequest) {
                console.log('XMLHttpRequest:');
                console.log(XMLHttpRequest);
                alert('网络异常！尝试刷新网页解决问题');
            }
        })
    });
    $('#out_btn').on('click',function () {
        $.ajax({
            url: root+'punch_out',
            type: 'POST',
            dataType: 'json',
            data: {
            },
            success: function (res) {
                var result = res.intdata;
                if (result >= 1) {
                    layer.msg("签退成功!");
                    out_time();
                } else if (result == -2) {
                    layer.msg("早退提示：当前未到签退时间!");
                }else if(result == -3){
                    layer.msg("您已签退，请勿重复签退!");
                }
            },
            error: function (XMLHttpRequest) {
                console.log('XMLHttpRequest:');
                console.log(XMLHttpRequest);
                alert('网络异常！尝试刷新网页解决问题');
            }
        })
    });

    //迟到
    $('#latego').on('click',function () {
        var remark = document.getElementById('lateresult').value;
        $.ajax({
            url: root+'late',
            type: 'POST',
            dataType: 'json',
            data: {
                remark: remark,
            },
            success: function (res) {
                var result = res.intdata;
                if (result > 0) {
                    layer.confirm("迟到原因填写成功!",{
                        btn:['确定']
                    },function (){
                        window.parent.location.reload();
                    })

                }
            },
            error: function (XMLHttpRequest) {
                console.log('XMLHttpRequest:');
                console.log(XMLHttpRequest);
                alert('网络异常！尝试刷新网页解决问题');
            }
        })
    })


</script>
</body>
</html>